---
interface Props {
  reviewId: string;
  initialCount: number;
}

const { reviewId, initialCount } = Astro.props;
---

<div class="helpful-button mt-4 pt-4 border-t border-gray-200" data-review-id={reviewId} data-initial-count={initialCount}>
  <p class="text-sm text-gray-600 mb-2">ã“ã®å£ã‚³ãƒŸã¯å‚è€ƒã«ãªã‚Šã¾ã—ãŸã‹?</p>
  <div class="flex items-center gap-2">
    <button
      class="helpful-btn px-4 py-2 rounded-md text-sm font-medium transition-all bg-blue-50 text-blue-700 hover:bg-blue-100 hover:shadow-sm"
      data-review-id={reviewId}
    >
      <span class="flex items-center gap-1">
        <span>ğŸ‘</span>
        <span>ã¯ã„</span>
        <span class="count-display ml-1 text-xs font-bold" style="display: none;"></span>
      </span>
    </button>

    <span class="success-message text-sm text-green-600 font-medium" style="display: none;">
      âœ“ ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼
    </span>

    <span class="loading-message text-sm text-gray-500" style="display: none;">
      é€ä¿¡ä¸­...
    </span>
  </div>
</div>

<script>
  // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²æ–¹å¼: ä¸¦ã³æ›¿ãˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã‚‚ç¢ºå®Ÿã«å‹•ä½œ
  // è¦ªè¦ç´ ï¼ˆdocumentï¼‰ã§ä¸€æ‹¬ãƒªã‚¹ãƒ³ã—ã€å¾Œã‹ã‚‰DOMã«è¿½åŠ ã•ã‚Œã‚‹ãƒœã‚¿ãƒ³ã‚‚100%æ‹¾ã†

  // åˆæœŸåŒ–é–¢æ•°: å…¨ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
  function initializeHelpfulButtons() {
    const containers = document.querySelectorAll('.helpful-button');

    containers.forEach((container) => {
      const reviewId = container.getAttribute('data-review-id');
      const initialCount = parseInt(container.getAttribute('data-initial-count') || '0', 10);
      const button = container.querySelector('.helpful-btn') as HTMLButtonElement;
      const countDisplay = container.querySelector('.count-display') as HTMLSpanElement;
      const successMessage = container.querySelector('.success-message') as HTMLSpanElement;

      if (!button || !reviewId) return;

      // åˆæœŸè¡¨ç¤º: ã‚«ã‚¦ãƒ³ãƒˆãŒ0ã‚ˆã‚Šå¤§ãã„å ´åˆã¯è¡¨ç¤º
      if (initialCount > 0) {
        countDisplay.textContent = `(${initialCount})`;
        countDisplay.style.display = 'inline';
      }

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰æ—¢ã«ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‹ã©ã†ã‹ã‚’ç¢ºèª
      const storageKey = `helpful-${reviewId}`;
      const hasClicked = localStorage.getItem(storageKey);

      if (hasClicked === 'true') {
        button.disabled = true;
        button.classList.remove('bg-blue-50', 'text-blue-700', 'hover:bg-blue-100', 'hover:shadow-sm');
        button.classList.add('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');
        successMessage.style.display = 'inline-block';
      }
    });
  }

  // DOMContentLoadedå¾Œã«åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', () => {
    initializeHelpfulButtons();

    // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²: documentå…¨ä½“ã§ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªã‚¹ãƒ³
    document.addEventListener('click', async (e) => {
      const target = e.target as HTMLElement;

      // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ãŒ helpful-btn ã¾ãŸã¯ ãã®å­è¦ç´ ã‹ãƒã‚§ãƒƒã‚¯
      const button = target.closest('.helpful-btn') as HTMLButtonElement;
      if (!button) return;

      // æ—¢ã«disabledãªã‚‰ä½•ã‚‚ã—ãªã„
      if (button.disabled) return;

      // è¦ªã‚³ãƒ³ãƒ†ãƒŠã¨reviewIdã‚’å–å¾—
      const container = button.closest('.helpful-button');
      if (!container) return;

      // â˜… in-flightãƒ­ãƒƒã‚¯: é€ä¿¡ä¸­ã®å†å…¥ã‚’æ§‹é€ çš„ã«é®æ–­
      if (container.dataset.sending === '1' || button.dataset.sending === '1') {
        console.log('[HelpfulButton] é€ä¿¡ä¸­ã®ãŸã‚ã€å†å…¥ã‚’é˜²æ­¢');
        return;
      }

      const reviewId = container.getAttribute('data-review-id');
      if (!reviewId) return;

      // UIè¦ç´ ã‚’å–å¾—
      const countDisplay = container.querySelector('.count-display') as HTMLSpanElement;
      const successMessage = container.querySelector('.success-message') as HTMLSpanElement;
      const loadingMessage = container.querySelector('.loading-message') as HTMLSpanElement;

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯ï¼ˆäºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢ï¼‰
      const storageKey = `helpful-${reviewId}`;
      if (localStorage.getItem(storageKey) === 'true') {
        return;
      }

      // UI: é€ä¿¡ä¸­çŠ¶æ…‹ + in-flightãƒ­ãƒƒã‚¯è¨­å®š
      container.dataset.sending = '1'; // â˜… é€ä¿¡ä¸­ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ï¼ˆcontainerï¼‰
      button.dataset.sending = '1';     // â˜… é€ä¿¡ä¸­ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ï¼ˆbuttonã€DOMå·®ã—æ›¿ãˆã‚±ãƒ¼ã‚¹å¯¾å¿œï¼‰
      button.disabled = true;
      button.classList.add('opacity-50', 'cursor-wait');
      loadingMessage.style.display = 'inline-block';

      console.log(`[HelpfulButton] ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º: reviewId=${reviewId}`); // ãƒ‡ãƒãƒƒã‚°ç”¨

      try {
        const response = await fetch('/.netlify/functions/helpful', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reviewId })
        });

        console.log(`[HelpfulButton] APIãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${response.status}`); // ãƒ‡ãƒãƒƒã‚°ç”¨

        if (response.ok) {
          const data = await response.json();
          const newCount = data.count;

          // â˜… countæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯: APIãŒå¿…ãšnumberã‚’è¿”ã™ä¿è¨¼
          if (typeof newCount !== 'number') {
            console.error('[HelpfulButton] APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ç•°å¸¸: countãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“', data);
            throw new Error('Invalid API response: count is not a number');
          }

          // UIæ›´æ–°: æˆåŠŸï¼ˆ0ä»¶æ™‚ã¯éè¡¨ç¤ºã‚’ç¶­æŒï¼‰
          if (newCount > 0) {
            countDisplay.textContent = `(${newCount})`;
            countDisplay.style.display = 'inline';
          }

          button.classList.remove('bg-blue-50', 'text-blue-700', 'hover:bg-blue-100', 'hover:shadow-sm', 'opacity-50', 'cursor-wait');
          button.classList.add('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');

          loadingMessage.style.display = 'none';
          successMessage.style.display = 'inline-block';

          // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
          localStorage.setItem(storageKey, 'true');

          console.log(`[HelpfulButton] æˆåŠŸ: count=${newCount}`); // ãƒ‡ãƒãƒƒã‚°ç”¨
        } else {
          // APIã‚¨ãƒ©ãƒ¼ï¼ˆ400/500ï¼‰
          const errorData = await response.json().catch(() => ({}));
          console.error('[HelpfulButton] APIã‚¨ãƒ©ãƒ¼:', response.status, errorData);
          alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆ${response.status}ï¼‰ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`);

          // UI: å…ƒã«æˆ»ã™ï¼ˆå†è©¦è¡Œå¯èƒ½ï¼‰
          button.disabled = false;
          button.classList.remove('opacity-50', 'cursor-wait');
          loadingMessage.style.display = 'none';
        }
      } catch (error) {
        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
        console.error('[HelpfulButton] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');

        // UI: å…ƒã«æˆ»ã™ï¼ˆå†è©¦è¡Œå¯èƒ½ï¼‰
        button.disabled = false;
        button.classList.remove('opacity-50', 'cursor-wait');
        loadingMessage.style.display = 'none';
      } finally {
        // â˜… in-flightãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆæˆåŠŸãƒ»å¤±æ•—å•ã‚ãšå¿…ãšå®Ÿè¡Œï¼‰
        delete container.dataset.sending;
        delete button.dataset.sending;
        console.log('[HelpfulButton] in-flightãƒ­ãƒƒã‚¯è§£é™¤');
      }
    });
  });

  // MutationObserver: DOMå¤‰æ›´ï¼ˆä¸¦ã³æ›¿ãˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰ã‚’ç›£è¦–ã—ã¦å†åˆæœŸåŒ–
  // ã“ã‚Œã«ã‚ˆã‚Šã€å¾Œã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚‚åˆæœŸçŠ¶æ…‹ï¼ˆã‚¯ãƒªãƒƒã‚¯æ¸ˆã¿è¡¨ç¤ºãªã©ï¼‰ãŒæ­£ã—ãåæ˜ ã•ã‚Œã‚‹
  if (typeof MutationObserver !== 'undefined') {
    let reinitTimeout: number | null = null;

    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹: é€£ç¶šç™ºç«ã‚’é˜²æ­¢ï¼ˆ200msï¼‰
    const debouncedReinit = () => {
      if (reinitTimeout !== null) {
        clearTimeout(reinitTimeout);
      }
      reinitTimeout = window.setTimeout(() => {
        initializeHelpfulButtons();
        reinitTimeout = null;
      }, 200);
    };

    const observer = new MutationObserver((mutations) => {
      let shouldReinit = false;

      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node instanceof Element) {
            // è¿½åŠ ã•ã‚ŒãŸãƒãƒ¼ãƒ‰è‡ªä½“ãŒ .helpful-button ã®å ´åˆ
            // ã¾ãŸã¯ å­å­«ã« .helpful-button ãŒå«ã¾ã‚Œã‚‹å ´åˆ
            if (node.matches('.helpful-button') || node.querySelector('.helpful-button')) {
              shouldReinit = true;
            }
          }
        });
      });

      if (shouldReinit) {
        debouncedReinit();
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      // ç›£è¦–å¯¾è±¡ã‚’å£ã‚³ãƒŸä¸€è¦§ã‚³ãƒ³ãƒ†ãƒŠã«é™å®šï¼ˆdocument.bodyå…¨åŸŸã¯éå‰°ï¼‰
      // ä¸¦ã³æ›¿ãˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§å¤‰æ›´ã•ã‚Œã‚‹éƒ¨åˆ†ã®ã¿ã‚’ç›£è¦–
      const reviewContainer = document.querySelector('.review-list, main, #reviews-container');
      const target = reviewContainer || document.body;

      observer.observe(target, {
        childList: true,
        subtree: true
      });

      console.log('[HelpfulButton] MutationObserverç›£è¦–é–‹å§‹:', target.className || 'document.body');
    });
  }
</script>

<style>
  .animate-fade-in {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
