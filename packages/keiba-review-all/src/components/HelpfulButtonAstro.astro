---
interface Props {
  reviewId: string;
  initialCount: number;
}

const { reviewId, initialCount } = Astro.props;
---

<div class="helpful-button mt-4 pt-4 border-t border-gray-200" data-review-id={reviewId} data-initial-count={initialCount}>
  <p class="text-sm text-gray-600 mb-2">ã“ã®å£ã‚³ãƒŸã¯å‚è€ƒã«ãªã‚Šã¾ã—ãŸã‹?</p>
  <div class="flex items-center gap-2">
    <button
      class="helpful-btn px-4 py-2 rounded-md text-sm font-medium transition-all bg-blue-50 text-blue-700 hover:bg-blue-100 hover:shadow-sm"
      data-review-id={reviewId}
    >
      <span class="flex items-center gap-1">
        <span>ğŸ‘</span>
        <span>ã¯ã„</span>
        <span class="count-display ml-1 text-xs font-bold" style="display: none;"></span>
      </span>
    </button>

    <span class="success-message text-sm text-green-600 font-medium" style="display: none;">
      âœ“ ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼
    </span>

    <span class="loading-message text-sm text-gray-500" style="display: none;">
      é€ä¿¡ä¸­...
    </span>
  </div>
</div>

<script>
  // DOMContentLoadedå¾Œã«å®Ÿè¡Œï¼ˆç¢ºå®Ÿã«DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰ï¼‰
  document.addEventListener('DOMContentLoaded', () => {
    // å…¨ã¦ã®å‚è€ƒã«ãªã£ãŸãƒœã‚¿ãƒ³ã‚’å–å¾—
    const containers = document.querySelectorAll('.helpful-button');

    containers.forEach((container) => {
      const reviewId = container.getAttribute('data-review-id');
      const initialCount = parseInt(container.getAttribute('data-initial-count') || '0', 10);
      const button = container.querySelector('.helpful-btn') as HTMLButtonElement;
      const countDisplay = container.querySelector('.count-display') as HTMLSpanElement;
      const successMessage = container.querySelector('.success-message') as HTMLSpanElement;
      const loadingMessage = container.querySelector('.loading-message') as HTMLSpanElement;

      if (!button || !reviewId) return;

      let count = initialCount;
      let clicked = false;
      let loading = false;

      // åˆæœŸè¡¨ç¤º: ã‚«ã‚¦ãƒ³ãƒˆãŒ0ã‚ˆã‚Šå¤§ãã„å ´åˆã¯è¡¨ç¤º
      if (count > 0) {
        countDisplay.textContent = `(${count})`;
        countDisplay.style.display = 'inline';
      }

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰æ—¢ã«ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‹ã©ã†ã‹ã‚’ç¢ºèª
      const storageKey = `helpful-${reviewId}`;
      const hasClicked = localStorage.getItem(storageKey);

      if (hasClicked === 'true') {
        clicked = true;
        button.disabled = true;
        button.classList.remove('bg-blue-50', 'text-blue-700', 'hover:bg-blue-100', 'hover:shadow-sm');
        button.classList.add('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');
        successMessage.style.display = 'inline-block';
      }

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      button.addEventListener('click', async () => {
        if (clicked || loading) return;

        loading = true;
        button.disabled = true;
        button.classList.add('opacity-50', 'cursor-wait');
        loadingMessage.style.display = 'inline-block';

        try {
          const response = await fetch('/.netlify/functions/helpful', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reviewId })
          });

          if (response.ok) {
            count += 1;
            clicked = true;

            // UIæ›´æ–°
            countDisplay.textContent = `(${count})`;
            countDisplay.style.display = 'inline';

            button.classList.remove('bg-blue-50', 'text-blue-700', 'hover:bg-blue-100', 'hover:shadow-sm', 'opacity-50', 'cursor-wait');
            button.classList.add('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');

            loadingMessage.style.display = 'none';
            successMessage.style.display = 'inline-block';

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem(storageKey, 'true');
          } else {
            console.error('Failed to update helpful count');
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');

            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã«æˆ»ã™
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-wait');
            loadingMessage.style.display = 'none';
            loading = false;
          }
        } catch (error) {
          console.error('Error:', error);
          alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');

          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã«æˆ»ã™
          button.disabled = false;
          button.classList.remove('opacity-50', 'cursor-wait');
          loadingMessage.style.display = 'none';
          loading = false;
        }
      });
    });
  });
</script>

<style>
  .animate-fade-in {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
